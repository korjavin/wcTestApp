{{define "content"}}
<div class="container">
    <section class="card">
        <h2>Connected Wallet</h2>
        <div class="wallet-info">
            <div class="info-row">
                <span class="label">Wallet Address:</span>
                <span class="value address">{{.WalletAddress}}</span>
            </div>
            <div class="info-row">
                <span class="label">Session ID:</span>
                <span class="value">{{.SessionID}}</span>
            </div>
            <div class="info-row">
                <span class="label">Status:</span>
                <span class="value status-active">Active</span>
            </div>
        </div>
        
        <div class="action-buttons">
            <button id="disconnect-button" class="secondary-button">Disconnect</button>
        </div>
    </section>
    
    <section class="card">
        <h2>Sign Message</h2>
        <form id="sign-form">
            <div class="form-group">
                <label for="message">Message to Sign:</label>
                <textarea id="message" name="message" rows="3" placeholder="Enter a message to sign">{{if .Message}}{{.Message}}{{else}}Hello, Ethereum! This message was signed using WalletConnect.{{end}}</textarea>
            </div>
            <button type="submit" class="primary-button">Sign Message</button>
        </form>
        
        <div id="signature-result" class="signature-result" {{if not .Signature}}style="display: none;"{{end}}>
            <h3>Signature Result</h3>
            <div class="info-row">
                <span class="label">Message:</span>
                <span class="value">{{.Message}}</span>
            </div>
            <div class="info-row">
                <span class="label">Signature:</span>
                <span class="value signature">{{.Signature}}</span>
            </div>
            
            {{if .SignatureDetails}}
            <h3>Signature Details</h3>
            <div class="signature-details">
                {{range $key, $value := .SignatureDetails}}
                <div class="info-row">
                    <span class="label">{{$key}}:</span>
                    <span class="value">{{$value}}</span>
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
    </section>
    
    <section class="card log-card">
        <h2>Connection Logs</h2>
        <div id="logs" class="logs">
            <p class="log-entry">Connected to wallet: {{.WalletAddress}}</p>
            {{if .Signature}}
            <p class="log-entry">Message signed successfully.</p>
            {{end}}
        </div>
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sessionId = '{{.SessionID}}';
        const disconnectButton = document.getElementById('disconnect-button');
        const signForm = document.getElementById('sign-form');
        const messageInput = document.getElementById('message');
        const signatureResult = document.getElementById('signature-result');
        const logs = document.getElementById('logs');
        
        function addLog(message) {
            const logEntry = document.createElement('p');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }
        
        disconnectButton.addEventListener('click', async function() {
            try {
                disconnectButton.disabled = true;
                addLog('Disconnecting wallet...');
                
                const response = await fetch(`/api/session/disconnect?session=${sessionId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to disconnect session');
                }
                
                addLog('Wallet disconnected successfully.');
                window.location.href = '/';
            } catch (error) {
                addLog(`Error: ${error.message}`);
                disconnectButton.disabled = false;
            }
        });
        
        signForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) {
                addLog('Error: Message cannot be empty');
                return;
            }
            
            try {
                const submitButton = signForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                addLog(`Requesting signature for message: "${message}"`);
                
                const response = await fetch('/api/message/sign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: message
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to sign message');
                }
                
                const data = await response.json();
                addLog('Message signed successfully.');
                
                // Redirect to show the signature
                window.location.href = `/connected?session=${sessionId}&message=${encodeURIComponent(message)}&signature=${encodeURIComponent(data.signature)}`;
            } catch (error) {
                addLog(`Error: ${error.message}`);
                const submitButton = signForm.querySelector('button[type="submit"]');
                submitButton.disabled = false;
            }
        });
    });
</script>
{{end}}